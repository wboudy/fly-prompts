# Command Palette

<!-- Generated by scripts/build_palette.py. Do not edit manually. -->
<!-- Source of truth: src/prompts/*.md frontmatter only (no legacy section). -->

## Generated Command Index

<!-- Source of truth: src/prompts/*.md frontmatter only. -->
<!-- BEGIN GENERATED COMMAND INDEX -->
```json
[
  {
    "command_key": "/bootstrap/register-roles",
    "stage": "bootstrap",
    "title": "Bootstrap: Register Roles and Thread",
    "source": "src/prompts/00_bootstrap__register_roles.md"
  },
  {
    "command_key": "/bootstrap/onboard-orient",
    "stage": "bootstrap",
    "title": "Onboard & Orient",
    "source": "src/prompts/01_bootstrap__onboard_orient.md"
  },
  {
    "command_key": "/bootstrap/check-agent-mail",
    "stage": "bootstrap",
    "title": "Check Agent Mail",
    "source": "src/prompts/02_bootstrap__check_agent_mail.md"
  },
  {
    "command_key": "/bootstrap/prepare-handoff",
    "stage": "bootstrap",
    "title": "Prepare Handoff",
    "source": "src/prompts/03_bootstrap__prepare_handoff.md"
  },
  {
    "command_key": "/bootstrap/post-status-update",
    "stage": "bootstrap",
    "title": "Post Status Update",
    "source": "src/prompts/04_bootstrap__post_status_update.md"
  },
  {
    "command_key": "/plan/cm-cass-plan-to-beads",
    "stage": "plan",
    "title": "Plan: CASS Context to Beads",
    "source": "src/prompts/10_plan__cm_cass_plan_to_beads.md"
  },
  {
    "command_key": "/plan/create-initial-plan",
    "stage": "plan",
    "title": "Create Initial Plan",
    "source": "src/prompts/11_plan__create_initial_plan.md"
  },
  {
    "command_key": "/plan/generate-brilliant-ideas",
    "stage": "plan",
    "title": "Generate Brilliant Ideas",
    "source": "src/prompts/12_plan__generate_brilliant_ideas.md"
  },
  {
    "command_key": "/plan/coordinate-plans",
    "stage": "plan",
    "title": "Coordinate Plans",
    "source": "src/prompts/13_plan__coordinate_plans.md"
  },
  {
    "command_key": "/plan/clarify-requirements",
    "stage": "plan",
    "title": "Clarify Requirements",
    "source": "src/prompts/14_plan__clarify_requirements.md"
  },
  {
    "command_key": "/plan/decompose-plan-into-beads",
    "stage": "plan",
    "title": "Decompose Plan Into Beads",
    "source": "src/prompts/15_plan__decompose_plan_into_beads.md"
  },
  {
    "command_key": "/plan/review-revise-beads",
    "stage": "plan",
    "title": "Review & Revise Beads",
    "source": "src/prompts/16_plan__review_revise_beads.md"
  },
  {
    "command_key": "/implement/claim-reserve-code-ubs-close",
    "stage": "implement",
    "title": "Implement: Claim, Reserve, Code, UBS, Close",
    "source": "src/prompts/30_impl__claim_reserve_code_ubs_close.md"
  },
  {
    "command_key": "/implement/swarm-open-beads",
    "stage": "implement",
    "title": "Swarm Open Beads",
    "source": "src/prompts/31_implement__swarm_open_beads.md"
  },
  {
    "command_key": "/implement/compact-context",
    "stage": "implement",
    "title": "Compact Context",
    "source": "src/prompts/32_implement__compact_context.md"
  },
  {
    "command_key": "/review/review-gate-ubs-dcg",
    "stage": "review",
    "title": "Review: Quality Gate with UBS and DCG",
    "source": "src/prompts/40_review__review_gate_ubs_dcg.md"
  },
  {
    "command_key": "/review/fresh-eyes-peer-review",
    "stage": "review",
    "title": "Fresh Eyes: Peer Review",
    "source": "src/prompts/41_review__fresh_eyes_peer_review.md"
  },
  {
    "command_key": "/review/fresh-eyes-ux-polish",
    "stage": "review",
    "title": "Fresh Eyes: UX Polish",
    "source": "src/prompts/42_review__fresh_eyes_ux_polish.md"
  },
  {
    "command_key": "/review/deep-diff-review",
    "stage": "review",
    "title": "Deep Diff Review",
    "source": "src/prompts/43_review__deep_diff_review.md"
  },
  {
    "command_key": "/release/sync-gate-slb-deploy",
    "stage": "release",
    "title": "Release: Sync Gate, SLB, Deploy",
    "source": "src/prompts/50_release__sync_gate_slb_deploy.md"
  },
  {
    "command_key": "/release/commit-grouped-changes",
    "stage": "release",
    "title": "Commit Grouped Changes",
    "source": "src/prompts/51_release__commit_grouped_changes.md"
  },
  {
    "command_key": "/release/pre-deploy-checks",
    "stage": "release",
    "title": "Pre-Deploy Checks",
    "source": "src/prompts/52_release__pre_deploy_checks.md"
  },
  {
    "command_key": "/release/deploy-wait",
    "stage": "release",
    "title": "Deploy & Wait",
    "source": "src/prompts/53_release__deploy_wait.md"
  },
  {
    "command_key": "/release/wrap-up-session",
    "stage": "release",
    "title": "Wrap Up Session",
    "source": "src/prompts/54_release__wrap_up_session.md"
  },
  {
    "command_key": "/incident/bug-hunt-to-bead",
    "stage": "incident",
    "title": "Incident: Bug Hunt to Bead",
    "source": "src/prompts/90_incident__bug_hunt_to_bead.md"
  },
  {
    "command_key": "/incident/fresh-eyes-bug-hunt",
    "stage": "incident",
    "title": "Fresh Eyes: Bug Hunt",
    "source": "src/prompts/91_incident__fresh_eyes_bug_hunt.md"
  },
  {
    "command_key": "/incident/debug-ci-failure",
    "stage": "incident",
    "title": "Debug CI Failure",
    "source": "src/prompts/92_incident__debug_ci_failure.md"
  }
]
```
<!-- END GENERATED COMMAND INDEX -->

## Bootstrap: Register Roles and Thread

### Goal
Establish one broadcast-safe coordination thread before any edits.

### Inputs
- Team roster and intended role split.
- Proposed `thread_id`.
- Initial file-surface ownership map.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Confirm one `thread_id` and shared mission statement.

Roles:
- Elect a Captain and assign Doer roles.
- Post exclusive file surfaces per role.

Steps:
1. Post `thread_id` and role table in Agent Mail.
2. Each agent ACKs with role + owned surfaces.
3. Captain confirms no overlapping reservations.

Sync:
- Gate: no implementation begins until all ACKs are posted.
- Any ownership change requires a new handoff message.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- All agents ACKed and ownership boundaries are conflict-free.

### Output
- One ACK per agent with role and reserved paths.
- Explicit "ready for next handoff" line.

## Onboard & Orient

### Goal
Execute the legacy "Onboard & Orient" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Read AGENTS.md and README.md in full — understand project conventions
- Register with MCP Agent Mail (MCP tool) using your pane name (e.g., cc_1)
- Check your inbox for messages from other agents or the overseer
- Search project history: `cass search "<project name>" --days 7 --limit 5`
- Run `bd ready` to see available work — do NOT claim yet
- Send a brief intro message via MCP Agent Mail (MCP tool) announcing your presence
- Review `bv` or `bd list --status=in_progress` to see what others are doing
- `cass search "error" --workspace .` — Recent errors in this project

Stage Tool Policy:
- Required: `ntm`
- Optional: `cass`, `cm`, `bd`/`br`, `bv`
- Triggers:
  - If selecting work, run `bd ready` or `br ready`.
  - If MCP Agent Mail tools are unavailable, coordinate via `ntm send <session> --all "<message>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Check Agent Mail

### Goal
Execute the legacy "Check Agent Mail" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Check your MCP Agent Mail (MCP tool) inbox
- Read all unread messages
- For each message requiring action:
- Acknowledge receipt
- Take requested action or explain why you cannot
- Update relevant beads if needed
- For coordination requests, respond with your availability and plan
- Mark messages as read once handled

Stage Tool Policy:
- Required: `ntm`
- Optional: `cass`, `cm`, `bd`/`br`, `bv`
- Triggers:
  - If selecting work, run `bd ready` or `br ready`.
  - If MCP Agent Mail tools are unavailable, coordinate via `ntm send <session> --all "<message>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Prepare Handoff

### Goal
Execute the legacy "Prepare Handoff" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Commit all code changes with clear messages
- Run `bd sync` to save bead state
- Update any in_progress beads with status comments
- Write a handoff document (see format below)
- Post handoff to MCP Agent Mail (MCP tool)
- Tag the next agent if known
- OAuth2 login flow (bd-a1b2c3)
- Token refresh middleware

Stage Tool Policy:
- Required: `ntm`
- Optional: `cass`, `cm`, `bd`/`br`, `bv`
- Triggers:
  - If selecting work, run `bd ready` or `br ready`.
  - If MCP Agent Mail tools are unavailable, coordinate via `ntm send <session> --all "<message>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Post Status Update

### Goal
Execute the legacy "Post Status Update" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Working on: [current bead or task]
- Progress: [percentage or milestone]
- Blockers: [none, or list]
- ETA: [estimate if known]
- Need: [nothing, or specific request]
- Working on: bd-x7y8z9 (rate limiting middleware)
- Progress: 60% — core logic done, writing tests
- Blockers: none

Stage Tool Policy:
- Required: `ntm`
- Optional: `cass`, `cm`, `bd`/`br`, `bv`
- Triggers:
  - If selecting work, run `bd ready` or `br ready`.
  - If MCP Agent Mail tools are unavailable, coordinate via `ntm send <session> --all "<message>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Plan: CASS Context to Beads

### Goal
Convert context into an execution plan with small, ordered beads.

### Inputs
- Current objective and constraints.
- Relevant history from CASS.
- Existing branch status and known risks.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Produce a minimal, testable implementation plan.

Roles:
- Planner drafts the sequence.
- Captain validates ownership and dependency order.

Steps:
1. Query CASS for prior decisions and failed attempts.
2. Draft milestones and acceptance checks.
3. Initialize tracking: `br init` (or `bd init` if alias).
4. Create beads with explicit owners, surfaces, and done criteria.
5. If flags/options are uncertain, run `br --help` before proceeding.

Sync:
- Gate: beads must map 1:1 to owned surfaces and validation commands.
- Broadcast the plan in Agent Mail using the shared `thread_id`.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- Bead list is ordered, owned, and ready for implementation.

### Output
- Plan summary with dependencies.
- Bead IDs + owners + acceptance checks.

## Create Initial Plan

### Goal
Draft a strong initial plan, then improve it with one explicit pre-implementation review loop.

### Inputs
- Existing markdown plan (or draft plan).
- Constraints, acceptance criteria, and architecture context.
- Ownership boundaries and tracker choice (`br` preferred / `bd` compatible).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Plan-space workflow:
- Search for prior art: `cass search "<feature or problem>" --limit 5`
- Review existing architecture: read README, AGENTS.md, key source files
- Identify constraints: performance, compatibility, dependencies
- Sketch state transitions, data flow, and component boundaries.

Plan Review Loop (pre-implementation, copy/paste template):
```text
Carefully review this entire plan for me and come up with your best revisions in terms of better architecture, new features, changed features, etc. to make it better, more robust/reliable, more performant, more compelling/useful, etc.

For each proposed change, give me your detailed analysis and rationale/justification for why it would make the project better along with the git-diff style changes relative to the original markdown plan shown below:

<PASTE YOUR EXISTING COMPLETE PLAN HERE>
```
- Run this once in an external frontier model review pass before implementation.
- Apply accepted changes in-place to the same plan file.
- Keep unresolved questions explicit as TODO bullets in the plan.

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- Revised plan (or plan diff) and rationale for major changes.
- Explicit open risks/questions before bead decomposition.
- Next owner and next plan-space action.

## Generate Brilliant Ideas

### Goal
Expand option space, then converge on high-value plan improvements.

### Inputs
- Current plan (or project state if already implemented).
- Constraints, risks, and success criteria.
- Tracker state for capturing selected ideas (`br` preferred / `bd` compatible).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Idea workflow:
- Include wild ideas, safe ideas, and everything between
- Do not self-censor during generation
- Aim for quantity over quality in this phase
- Impact: How much value does this deliver?
- Effort: How hard is this to implement? (10 = easy, 1 = hard)
- Select top candidates by value-to-effort ratio.

Radical Innovation Nudge (copy/paste template):
```text
What's the single smartest and most radically innovative and accretive and useful and compelling addition you could make to the plan at this point?
```
- If development has already started, replace the word `plan` with `project`.
- Add accepted ideas into the plan (or convert directly into `br`/`bd` issues).

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- Ranked idea shortlist with rationale.
- Chosen ideas integrated into plan/issue tracker.
- Explicitly rejected ideas and why.

## Coordinate Plans

### Goal
Coordinate multiple planning streams and produce one aligned execution plan.

### Inputs
- Current objective and active plan variants.
- Collaboration context (NTM session + ownership boundaries).
- Tracker state (`br` preferred / `bd` compatible).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Coordination workflow:
- Collect active plan proposals and identify overlap/conflict.
- Align ownership and sequencing before implementation starts.
- Keep one merged plan as source and track rejected alternatives explicitly.

Multi-Model Hybridization (copy/paste template):
```text
I asked 3 competing LLMs to do the exact same thing and they came up with pretty different plans which you can read below. I want you to REALLY carefully analyze their plans with an open mind and be intellectually honest about what they did that's better than your plan. Then I want you to come up with the best possible revisions to your plan (you should simply update your existing document for your original plan with the revisions) that artfully and skillfully blends the "best of all worlds" to create a true, ultimate, superior hybrid version of the plan that best achieves our stated goals and will work the best in real-world practice to solve the problems we are facing and our overarching goals while ensuring the extreme success of the enterprise as best as possible; you should provide me with a complete series of git-diff style changes to your original plan to turn it into the new, enhanced, much longer and detailed plan that integrates the best of all the plans with every good idea included (you don't need to mention which ideas came from which models in the final revised enhanced plan):
```
- Require git-diff style plan changes as output.
- Use `ntm send <session> --all "<summary>"` fallback if MCP Agent Mail tools are unavailable.

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- Merged plan decision and rejected alternatives summary.
- Ownership split, dependency order, and next planning owner.
- Any blockers requiring escalation.

## Clarify Requirements

### Goal
Execute the legacy "Clarify Requirements" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Review the current goal, beads, or instructions
- Identify every assumption you are making
- List every ambiguous point — scope, format, edge cases, priorities
- Formulate specific questions for each ambiguity
- Send questions to the overseer via MCP Agent Mail (MCP tool) or direct message
- WAIT for answers before proceeding
- Repeat until no ambiguities remain
- Context: [what you are trying to decide]

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Decompose Plan Into Beads

### Goal
Convert an approved plan into implementation-ready issues with complete context.

### Inputs
- Final approved plan markdown.
- Constraints, test strategy, and logging requirements.
- Tracker choice (`br` preferred / `bd` compatible).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Decomposition workflow:
- Run an explicit ambiguity gate and record `blocking_ambiguities=<N>` in an artifact.
- Proceed with issue creation only when `blocking_ambiguities=0`.
- If `blocking_ambiguities>0`, stop decomposition and emit `NO_BEAD_CREATION_DUE_TO_AMBIGUITY` plus exact clarifying questions.
- Break work into small, testable, dependency-aware issues.
- Prefer `br` commands; use `bd` only for compatibility with existing repos.

Required acceptance criteria for each issue:
- Issue includes enough context to implement without reopening the plan file.
- Issue preserves full feature scope; no silent feature/functionality loss.
- Issue includes explicit unit-test requirements.
- Issue includes explicit end-to-end (e2e) test requirements.
- Issue includes detailed logging/observability expectations for verification.
- Dependency links are explicit and validated with `bv --robot-insights` when graph complexity is high.
- Decomposition report includes `ambiguity_gate=PASS`, ambiguity artifact path, and created issue IDs (only when gate passes).

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- Issue list with ownership, dependencies, and acceptance criteria.
- Confirmation that each issue is self-contained relative to the plan.
- Gaps that still require plan updates before implementation.
- Explicit ambiguity-gate result:
  - PASS path: `blocking_ambiguities=0`, artifact path, and created issue IDs.
  - FAIL path: `NO_BEAD_CREATION_DUE_TO_AMBIGUITY` with blocking questions.

## Review & Revise Beads

### Goal
Iteratively improve issue quality in plan space before implementation begins.

### Inputs
- Current issue set (`br` preferred / `bd` compatible).
- Approved plan markdown and acceptance criteria.
- Quality and risk constraints.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Revision workflow:
- `bv --robot-triage` — Full analysis: recommendations, quick wins, blockers
- `bv --robot-insights` — Graph metrics: cycles, bottlenecks, PageRank
- `bv --robot-plan` — Execution plan with parallel tracks
- `bv --robot-priority` — Priority recommendations with reasoning
- Iterate in plan space until issues are stable and implementation-ready.

Bead Revision Loop (copy/paste template; no outdated reasoning tags):
```text
Reread AGENTS.md so it's fresh in your mind. Then review every issue carefully. Are you sure each one is optimal? Could anything make the system work better for users? If so, revise the issues now while we're still in plan space.

Do NOT oversimplify. Do NOT lose features or functionality. Ensure every issue embeds the required plan context so implementers never need to refer back to the plan file. Ensure each issue includes comprehensive unit tests, end-to-end tests, and detailed logging requirements.
```
- Prefer `br` terminology in new issue edits; keep `bd` compatibility where needed.

Stage Tool Policy:
- Required: `cass` and one issue tracker (`bd` or `br`)
- Optional: `cm`, `bv`, `apr`
- Triggers:
  - If planning dependencies, run `bv --robot-plan` and `bv --robot-insights`.
  - If creating tasks, use either `bd create ...` or `br create ...` consistently for the repo.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- Revised issue set with rationale for major changes.
- Explicit confirmation: no feature loss during revision loop.
- Remaining blockers before implementation handoff.

## Implement: Claim, Reserve, Code, UBS, Close

### Goal
Execute assigned beads with explicit reservations and safe sync points.

### Inputs
- Assigned bead IDs and acceptance criteria.
- Reserved file surfaces.
- Current branch and test/lint commands.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Land code changes for assigned beads without ownership conflicts.

Roles:
- Doer edits only reserved surfaces.
- Review partner stays read-only until handoff.

Steps:
1. Claim bead in Agent Mail (`thread_id`, bead ID, reserved paths).
2. Implement only on reserved files.
3. Run local checks required by bead.
4. Run UBS for touched code paths before closing bead.
5. Update bead status and close when acceptance checks pass.

Sync:
- Gate: no bead closure without check outputs + UBS mention.
- Post reservation release or transfer in Agent Mail.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- Bead closed with evidence, and reservations updated.

### Output
- Change summary by file.
- Validation list (lint/build/tests/UBS) and bead closure note.

## Swarm Open Beads

### Goal
Execute the legacy "Swarm Open Beads" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Launch or attach a multi-agent session, then confirm health: `ntm doctor`, `ntm status <session>`.
- Prime all workers before coding:
  - `ntm send <session> "Read AGENTS.md and README.md carefully. Understand architecture, execution flows, and project purpose."`
- Run exploration + fix pass with fresh eyes:
  - `ntm send <session> "Randomly explore code files, trace imports/callers deeply, find obvious bugs/issues, and fix them while following AGENTS.md rules."`
- Run peer-agent review pass before handoff:
  - `ntm send <session> "Review code written by fellow agents, cast a wider net beyond latest commits, diagnose root causes, and patch issues."`
- Track assignments/findings in `br` (preferred) or `bd` to avoid overlap.
- For dangerous ops (force push, `rm -rf`), use `slb run "<command>"` for two-person auth.

Stage Tool Policy:
- Required: one issue tracker (`bd` or `br`) and `ntm`
- Optional: `cass`, `cm`, `ubs`, `dcg`
- Triggers:
  - Before commit readiness checks, run `ubs --staged` (or `ubs .` for full scan).
  - For dangerous operations, use `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Compact Context

### Goal
Execute the legacy "Compact Context" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- List what you have completed this session
- List what remains to be done
- Note any blockers, open questions, or partial work
- Write a handoff summary to MCP Agent Mail (MCP tool) or a bead comment
- Run `bd sync` to commit bead changes
- Commit any code changes with clear messages
- Do NOT lose work — commit and sync before compacting
- Do NOT leave ambiguous state — be explicit about what is done vs pending

Stage Tool Policy:
- Required: one issue tracker (`bd` or `br`) and `ntm`
- Optional: `cass`, `cm`, `ubs`, `dcg`
- Triggers:
  - Before commit readiness checks, run `ubs --staged` (or `ubs .` for full scan).
  - For dangerous operations, use `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Review: Quality Gate with UBS and DCG

### Goal
Run a focused review pass to catch regressions before release.

### Inputs
- Candidate diff/commit range.
- Acceptance criteria from plan/beads.
- Safety policies for destructive commands.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Approve only changes that satisfy behavior, safety, and ownership rules.

Roles:
- Reviewer inspects diff and checks.
- Doer addresses findings on owned surfaces.

Steps:
1. Review changed files for correctness and scope drift.
2. Re-run required checks and confirm outputs.
3. Run UBS on changed code areas and note findings.
4. Confirm DCG protections are respected for risky operations.
5. Request fixes or approve with explicit rationale.

Sync:
- Gate: no release handoff until blockers are resolved.
- Send findings in Agent Mail with `thread_id`, severity, owner.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- Review decision posted (approved or blocked) with concrete evidence.

### Output
- Findings list by severity.
- Final gate status and next owner.

## Fresh Eyes: Peer Review

### Goal
Execute the legacy "Fresh Eyes: Peer Review" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Review fellow-agent changes across a recent window (for example, last 7 days), not just the latest commit.
- For each peer change, inspect touched files and neighboring/import-linked files.
- Follow the ripple: verify assumptions still hold across dependent modules.
- Use first-principles analysis; diagnose root causes before proposing fixes.
- Check for bugs, inefficiencies, security issues, and reliability gaps in peer-written code.

Peer-Agent Review Template (copy/paste):
```text
Turn your attention to reviewing the code written by your fellow agents. Check for issues, bugs, inefficiencies, security or reliability problems. Do not restrict yourself to the latest commits; cast a wider net and go deep. Diagnose root causes and fix or revise where needed.
```

Stage Tool Policy:
- Required: `bv` robot modes and `ntm`
- Optional: `cass`, `ubs`, `dcg`
- Triggers:
  - Use `bv --robot-triage` for prioritization and `bv --robot-insights` for dependency risk.
  - If reviewing changed files, run `ubs --staged` before approval.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Fresh Eyes: UX Polish

### Goal
Execute the legacy "Fresh Eyes: UX Polish" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- **Workflows:** Walk through every user-facing flow end-to-end. Where does it feel clunky?
- **UI polish:** Spacing, alignment, typography, color consistency, loading states
- **Error states:** What happens when things go wrong? Are error messages helpful or cryptic?
- **Edge cases:** Empty states, long strings, slow connections, rapid clicks
- **Micro-interactions:** Hover states, transitions, feedback on actions
- **Copy:** Is the text clear, concise, and consistent? Any jargon leaking through?
- **Performance feel:** Does anything feel sluggish? Unnecessary spinners?
- **Accessibility:** Keyboard navigation, screen reader compatibility, contrast ratios

Stage Tool Policy:
- Required: `bv` robot modes and `ntm`
- Optional: `cass`, `ubs`, `dcg`
- Triggers:
  - Use `bv --robot-triage` for prioritization and `bv --robot-insights` for dependency risk.
  - If reviewing changed files, run `ubs --staged` before approval.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Deep Diff Review

### Goal
Execute the legacy "Deep Diff Review" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Start with `git status` and `git diff`, then widen scope beyond tip-of-branch changes.
- Review recent history and peer commits; do not restrict analysis to the latest commit set.
- For each changed file, trace upstream callers and downstream dependencies.
- Ask "what could go wrong?" at boundaries, error paths, and security-sensitive flows.
- Use first-principles root-cause analysis; avoid symptom-only fixes.
- Verify tests cover new and regressed paths, then record residual risks explicitly.

Stage Tool Policy:
- Required: `bv` robot modes and `ntm`
- Optional: `cass`, `ubs`, `dcg`
- Triggers:
  - Use `bv --robot-triage` for prioritization and `bv --robot-insights` for dependency risk.
  - If reviewing changed files, run `ubs --staged` before approval.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Release: Sync Gate, SLB, Deploy

### Goal
Ship validated changes with explicit sync gates and operator checks.

### Inputs
- Approved commit set.
- Required release checklist.
- CI and deployment context.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Perform a controlled release with documented verification.

Roles:
- Release owner runs checks and deploy commands.
- Observer verifies commands and outcomes.

Steps:
1. Run release gate checks (`make lint`, `make build`, tests as required).
2. Confirm no unresolved review blockers.
3. Use SLB workflow where two-person authorization is required.
4. Deploy using project-approved commands.
5. If command details are unclear, run `br --help` and tool `--help` first.

Sync:
- Gate: deploy starts only after gate checks + approvals are posted.
- Post release status in Agent Mail (`thread_id`, version/commit, outcome).

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- Deployment result and rollback posture are documented.

### Output
- Release checklist results.
- Deploy outcome, follow-ups, and owner.
- Legacy prompts append check confirmed.

## Commit Grouped Changes

### Goal
Execute the legacy "Commit Grouped Changes" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Run `git status` to see all changes
- Group related changes by feature, fix, or concern
- For each group:
- Stage only those files: `git add <files>`
- Write a detailed commit message (see format below)
- Commit: `git commit`
- Run `bd sync` to commit bead changes separately
- Review commit history: `git log --oneline -10`

Stage Tool Policy:
- Required: `ubs` and `ntm`
- Optional: `slb`, `bd`/`br`, `ru`
- Triggers:
  - Run `ubs --staged` (or `ubs .`) before release sign-off.
  - Gate risky commands through `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Pre-Deploy Checks

### Goal
Execute the legacy "Pre-Deploy Checks" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Run the full test suite — fix any failures
- Run UBS (Ultimate Bug Scanner): `ubs .`
- Review UBS findings — fix critical and high severity issues
- Create beads for issues you cannot fix now: `bd create --title="..." --type=bug`
- Run linter and formatter — commit any fixes
- Check for uncommitted changes: `git status`
- Ensure all beads are synced: `bd sync`
- For any dangerous commands, route through SLB: `slb run "<command>"`

Stage Tool Policy:
- Required: `ubs` and `ntm`
- Optional: `slb`, `bd`/`br`, `ru`
- Triggers:
  - Run `ubs --staged` (or `ubs .`) before release sign-off.
  - Gate risky commands through `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Deploy & Wait

### Goal
Execute the legacy "Deploy & Wait" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Push to remote: `git push`
- Create PR if needed: open or update the PR using your standard repo workflow
- Note the CI/deploy URL
- STOP and WAIT — do not proceed until CI completes
- If CI passes, report success via MCP Agent Mail (MCP tool)
- If CI fails, proceed to `debug-ci-failure` prompt
- Route through SLB: `slb run "<command>" --reason "<justification>"`
- Wait for approval before proceeding

Stage Tool Policy:
- Required: `ubs` and `ntm`
- Optional: `slb`, `bd`/`br`, `ru`
- Triggers:
  - Run `ubs --staged` (or `ubs .`) before release sign-off.
  - Gate risky commands through `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Wrap Up Session

### Goal
Execute the legacy "Wrap Up Session" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Commit all pending changes with clear messages
- Run `bd sync` to commit bead changes
- Update in_progress beads — either close or add status comments
- Post final status to MCP Agent Mail (MCP tool)
- Push all commits: `git push`
- Run `bd list --status=in_progress` — ensure nothing is orphaned
- Sign off via MCP Agent Mail (MCP tool)
- Closed: bd-a1b2c3, bd-d4e5f6

Stage Tool Policy:
- Required: `ubs` and `ntm`
- Optional: `slb`, `bd`/`br`, `ru`
- Triggers:
  - Run `ubs --staged` (or `ubs .`) before release sign-off.
  - Gate risky commands through `slb run "<command>"`.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Incident: Bug Hunt to Bead

### Goal
Triage an incident and convert it into an owned, testable bead.

### Inputs
- Incident symptom, logs, and reproduction hints.
- Current branch/commit and recent changes.
- Severity and business impact.

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Goal:
- Reproduce, contain, and route the fix with clear ownership.

Roles:
- Incident lead coordinates triage.
- Fix owner implements and validates remediation.

Steps:
1. Capture minimal repro and blast radius.
2. Search CASS for related incidents and prior fixes.
3. Create/assign a bead for remediation (`br init` or `bd init` if alias).
4. Implement fix on reserved surfaces and add/adjust tests.
5. Run UBS on changed code and attach relevant results.

Sync:
- Gate: incident is not closed until repro is resolved and checks pass.
- Post timeline updates in Agent Mail with `thread_id` and next checkpoint.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

Done:
- Incident status, fix bead, and verification evidence are recorded.

### Output
- Triage summary and root-cause hypothesis.
- Bead assignment, fix evidence, and closure recommendation.

## Fresh Eyes: Bug Hunt

### Goal
Execute the legacy "Fresh Eyes: Bug Hunt" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Choose a starting file outside your recent edit set, then inspect deeply.
- Trace execution flow in both directions: callers, callees, and import-linked modules.
- Record what the code should do, then compare behavior for fresh-eyes discrepancies.
- Fix discovered issues systematically (logic bugs, boundary mistakes, reliability gaps), then continue with a new file.
- Repeat in random-but-methodical passes until coverage and confidence are acceptable.

Persistence Mode (Use Sparingly, optional):
```text
I know for a fact that there are at least 87 serious bugs throughout this project impacting every facet of its operation. The question is whether you can find and diagnose and fix all of them autonomously. I believe in you.
```
- Warning: this can drive false positives and time waste if used too long.
- Only use when normal triage stalls; set a timebox and explicit stop criteria.

Stage Tool Policy:
- Required: `cass`, `ubs`, and one issue tracker (`bd` or `br`)
- Optional: `ntm`, `cm`, `bv`
- Triggers:
  - Use `ubs <path>` for targeted scans while triaging incidents.
  - Record remediation work in `bd` or `br` and broadcast status via `ntm send` when needed.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.

## Debug CI Failure

### Goal
Execute the legacy "Debug CI Failure" workflow as a prompt-backed, stage-scoped command.

### Inputs
- Current objective, constraints, and relevant files.
- Active branch, changed files, and validation commands.
- Collaboration context (NTM session + issue tracker state).

### Instructions
- Use one `thread_id` across all agents and include it in Agent Mail subjects.
- Reserve file surfaces before edits (`claim`, `owner`, `paths`) and avoid overlap.
- Keep non-doers read-only unless a new handoff explicitly reassigns ownership.
- If command flags are unclear, run `br --help` (or tool-specific `--help`) before execution.

Workflow (condensed from legacy command):
- Get the CI logs: your CI log viewer or CI URL
- Identify the failing step and error message
- Reproduce locally if possible
- Run UBS on affected files: `ubs <path>`
- Create a bead for the fix: `bd create --title="Fix CI: <issue>" --type=bug --priority=1`
- Fix the issue
- Run pre_deploy checks again before pushing
- Test failure: Run the specific test locally, check for flaky tests

Stage Tool Policy:
- Required: `cass`, `ubs`, and one issue tracker (`bd` or `br`)
- Optional: `ntm`, `cm`, `bv`
- Triggers:
  - Use `ubs <path>` for targeted scans while triaging incidents.
  - Record remediation work in `bd` or `br` and broadcast status via `ntm send` when needed.
- Use installed-tool commands from `docs/TOOLS_QUICKREF.md` only.

Coordination Note:
- `agent-mail` / `mcp_agent_mail` are MCP server binaries, not shell workflow CLIs.
- Prefer MCP Agent Mail tools when available; otherwise use `ntm send` fallback.

- Report: status, changed files, validations, and ownership handoff.
- Include the sync gate result (`make lint`, `make build`, tests/tool checks run).
- If blocked, name blocker, owner, and exact next action.

### Output
- What was done, what is next, and who owns the next action.
- Key commands/checks executed and their outcomes.
- Any blockers and explicit handoff details.
